# PowerNap 開發大綱

## 第一階段：基礎設置與數據獲取
1. **專案架構設置**
   - 建立 Apple Watch 應用專案結構
   - 配置必要的權限（HealthKit、通知等）
   - 設置基本 UI 框架

2. **資料存取層實現**
   - 實現 HealthKit 連接，取得心率數據 
   - 建立 CoreMotion 數據收集機制
   - 開發數據處理工具類（計算心率數據、活動級別）

3. **背景監測機制**
   - 實現 WKExtendedRuntimeSession 配置
   - 建立電池優化的數據收集策略
   - 開發感測器使用協調器

## 第二階段：睡眠監測演算法
1. **HR 與 RHR 監測**
   - 收集使用者基準 RHR（過去7天平均靜息心率）
   - 實現基於年齡的心率閾值判定（即時 HR 低於個人 RHR 的 X%）
     - 18-59歲：低於 RHR 的 90%，且維持 ≥ 3 分鐘
     - 其他年齡段根據指導文件調整
   - 建立心率趨勢分析機制

2. **活動監測**
   - 實現動作監測演算法
   - 定義並調整 Motion_level 閾值
   - 建立動態活動窗口分析

3. **綜合判定**
   - 整合心率與活動數據
   - 實現持續時間判斷（根據年齡組2-4分鐘條件滿足）
   - 開發入睡偵測狀態機

## 第三階段：計時與喚醒功能
1. **計時選項界面**
   - 開發 1-30 分鐘範圍的滾輪選擇器 UI
   - 實現自由時間選擇邏輯
   - 建立使用者設定儲存機制

2. **倒數計時機制**
   - 實現入睡後計時啟動邏輯
   - 開發背景計時器
   - 設計 UI 更新機制

3. **喚醒通知**
   - 實現 UNUserNotificationCenter 配置
   - 開發喚醒聲音與震動機制
   - 建立喚醒後數據摘要顯示

## 第四階段：UI設計與使用者體驗
1. **主介面設計**
   - 開發簡潔的啟動與設置界面
   - 實現計時進度顯示
   - 設計睡眠狀態反饋指示器

2. **錶盤複雜功能**
   - 開發 Complication 設計
   - 實現快速啟動機制
   - 建立複雜功能狀態更新邏輯

3. **交互優化**
   - 優化觸控操作
   - 改進狀態轉換動畫
   - 設計錯誤處理與引導

4. **基本視覺識別**
   - 設計基本 App Icon（符合 Apple 規範要求）
   - 確定應用主色調與基本色彩系統
   - 實現一致的視覺語言與圖標風格

## 用戶流程設計

### 首次啟動流程
1. **Welcome 歡迎頁面** - 提供簡單的歡迎信息
2. **App 簡介頁面** - 50-100字的簡介，可捲動，概述應用功能和價值
3. **權限需求說明** - 解釋為什麼應用需要健康和通知權限
4. **權限請求頁面** - 正式請求必要的用戶權限

### 主要功能流程
採用左右分頁結構設計，包含三個主要頁面:

1. **主頁面** - 顯示核心功能界面，包含:
   - 休息時間設定
   - 開始/停止休息按鈕
   - 睡眠狀態和倒計時顯示

2. **第二分頁** - 顯示詳細數據與狀態:
   - 即時心率顯示
   - 靜息心率基準
   - 動作判定狀態
   - 睡眠判定進度
   - 其他開發者確認狀態

3. **第三分頁** - 應用設置與狀態:
   - 各項權限狀態顯示
   - 通知設置
   - 執行狀況回報按鈕
   - 診斷工具與日誌

### 啟動模式
1. **冷啟動流程**:
   - 檢查是否為首次啟動
   - 若是首次啟動，進入 Onboarding 流程
   - 若非首次啟動，進入主用戶流程

2. **熱啟動流程**:
   - 直接進入主頁面

## 第五階段：測試與優化
1. **功能測試**
   - 測試入睡偵測準確性
   - 驗證不同時間選項的計時功能
   - 測試通知喚醒可靠性

2. **效能優化**
   - 分析與優化電池消耗
   - 改進背景執行效率
   - 優化感測器使用頻率
   - 實現異步操作優化
     - 重構 HealthKitService 異步處理
     - 優化 SleepDetectionService
     - 確保 PowerNapViewModel 的異步操作穩定性
     - 處理背景數據傳遞的異步問題
   - **設備特定優化**：
     - 針對 Series 6+ 設備優化內存使用
     - 確保大型數據結構有效釋放
     - 實施按需加載策略

3. **使用者測試**
   - 收集實際使用反饋
   - 調整演算法閾值
   - 改進使用者體驗

## 第六階段（選擇性）：增強功能
1. **數據統計與分析**
   - 開發入睡速度統計
   - 實現歷史記錄查看
   - 建立趨勢圖表顯示

2. **個人化設定**
   - 實現閾值微調界面
   - 開發自定義喚醒聲音
   - 建立個人化設定同步機制

3. **進階整合**
   - 實現健康應用數據共享
   - 開發與 iPhone 應用的深度整合
   - 建立雲端備份與同步機制

4. **視覺設計強化**
   - 設計與製作高品質 App Icon（含各尺寸規格）
   - 開發多主題視覺風格與色彩系統
   - 建立完整的視覺設計指南
   - 製作促銷與上架素材（螢幕截圖、預覽影片）

## 硬體兼容性測試計劃
- **目標最低支援**：Apple Watch Series 6+
- **測試環境**：優先使用 Series 9（實機）完成功能開發
- **兼容性測試**：在功能完成後使用各種模擬器測試基本功能
- **重點測試**：內存使用、UI響應性、算法執行時間

---

## 開發進度追蹤

### 第一階段
- [x] 專案架構設置
- [x] 資料存取層實現
- [x] 背景監測機制

### 第二階段
- [x] HR 與 RHR 監測
- [x] 活動監測
- [x] 綜合判定

### 第三階段
- [x] 計時選項界面
- [x] 倒數計時機制
- [ ] 喚醒通知

### 第四階段
- [x] 主介面設計
- [ ] 錶盤複雜功能
- [x] 交互優化
- [ ] 基本視覺識別

### 第五階段
- [ ] 功能測試
- [ ] 效能優化
- [ ] 使用者測試

### 第六階段
- [ ] 數據統計與分析
- [ ] 個人化設定
- [ ] 進階整合
- [ ] 視覺設計強化

## 里程碑

1. **MVP 版本** - 完成第一至第三階段的所有功能，具備基本的入睡偵測與喚醒功能
2. **Beta 版本** - 完成第四階段及第五階段的基本測試，UI 完善且穩定可用
3. **正式版本** - 完成第五階段的所有優化，準備上架
4. **進階版本** - 實現第六階段的增強功能（選擇性）

## 注意事項

- 各階段可能會根據實際開發情況進行調整
- 技術難點主要在於入睡偵測演算法和背景執行機制
- 請在每個功能點完成後進行充分測試
- 電池消耗是關鍵考量因素，應貫穿整個開發過程 