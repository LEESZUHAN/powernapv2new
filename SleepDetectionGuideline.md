# PowerNap 睡眠檢測機制說明

## 概述

PowerNap 應用使用多層次的檢測系統來準確判定用戶何時進入睡眠狀態，確保在用戶真正入睡後才開始計時。本文檔詳細說明了檢測機制的工作原理、關鍵參數和判定邏輯。

## 動作檢測機制

### 核心參數

| 參數 | 默認值 | 說明 |
|------|--------|------|
| motionThreshold | 0.02 | 動作閾值，低於此值視為靜止 |
| windowSize | 300 | 基礎動作數據的觀察窗口大小（5分鐘） |
| shortWindowSize | 20 | 短時間觀察窗口（20秒），用於即時檢測 |
| autoAdjustThreshold | true | 是否啟用自適應閾值調整 |

### 年齡組窗口設置

每個用戶根據年齡組會有不同的窗口配置：

| 年齡組 | 主窗口大小 | 所需靜止占比 | 確認時間 | 說明 |
|--------|------------|--------------|----------|------|
| 青少年 (10-17歲) | 60秒 | 90% | 120秒 | 較短窗口，嚴格靜止要求 |
| 成人 (18-59歲) | 180秒 | 85% | 180秒 | 中等窗口，平衡靜止要求 |
| 銀髮族 (60歲以上) | 300秒 | 80% | 240秒 | 較長窗口，寬容靜止要求 |

> 注意：除了年齡組特定窗口外，系統也維護20秒短窗口用於快速反應變化。

### 動作數據處理流程

1. **數據採集**：
   - 使用加速度計每秒採集一次數據
   - 計算加速度向量大小：`sqrt(x*x + y*y + z*z) - 1.0`（扣除重力）
   - 取絕對值後保存為動作強度

2. **窗口平均處理**：
   - 年齡組特定窗口：用於穩定判定整體趨勢，窗口大小根據年齡組調整
   - 短窗口（20秒）：用於敏感捕捉突然變化，所有年齡組通用

3. **滑動窗口機制**：
   - 系統不是僅在固定時間點計算一次，而是持續更新窗口數據
   - 新數據加入窗口時，最舊的數據會被移除（先進先出）
   - 每秒更新一次滑動窗口的平均值和靜止占比
   - 舉例：3分鐘窗口包含180個樣本，每秒新增1個樣本並移除最舊樣本

4. **靜止判定**：
   - 計算靜止時間佔比 = 靜止樣本數 / 總樣本數
   - 當靜止佔比 ≥ 年齡組要求百分比時，判定為靜止
   - 需要連續靜止達到年齡組確認時間才觸發睡眠條件

5. **自適應閾值**：
   - 每分鐘根據最近的動作數據自動調整閾值
   - 調整公式：`平均動作值 + 標準差`
   - 限制範圍：0.015 ~ 0.05，確保閾值合理
   - 自適應過程：
     1. 收集最近5分鐘的動作數據
     2. 計算這些數據的平均值和標準差
     3. 新閾值 = 平均值 + 標準差
     4. 應用上下限確保閾值在合理範圍內
     5. 平滑過渡到新閾值，避免突變
   - 目的：自動適應用戶的睡眠習慣和環境干擾

## 心率監測機制

### 核心參數

| 參數 | 默認值 | 適用年齡組 | 說明 |
|------|--------|------------|------|
| hrThresholdTeens | 0.875 | 10-17歲 | 心率閾值為RHR的87.5%（85-90%） |
| hrThresholdAdults | 0.90 | 18-59歲 | 心率閾值為RHR的90% |
| hrThresholdSeniors | 0.935 | ≥60歲 | 心率閾值為RHR的93.5%（92-95%） |
| athleteRhrThreshold | 40 | 所有年齡 | 運動員RHR判定閾值（bpm） |
| hrDropThreshold | 5 | 運動員模式 | 心率下降閾值（bpm） |

### 心率分析流程

1. **靜息心率獲取**：
   - 從HealthKit讀取用戶的靜息心率(RHR)數據
   - 若無法獲取，使用過去7天清晨心率平均值估算

2. **年齡組判定**：
   - 基於用戶設定的年齡組選擇適當的閾值百分比
   - 不同年齡組使用不同的判定時間窗口

3. **運動員模式判斷**：
   - 若用戶RHR < 40 bpm，自動啟用運動員模式
   - 運動員模式使用心率下降幅度（≥ 5 bpm）作為輔助判準

4. **實時監測**：
   - 每15秒獲取一次最新心率數據
   - 將當前心率與閾值（RHR × 年齡組閾值比例）比較

5. **下降判定**：
   - 非運動員模式：當當前心率 ≤ RHR × 閾值比例時，判定為心率條件滿足
   - 運動員模式：當當前心率 < RHR - hrDropThreshold時，判定為心率條件滿足

### 個人化心率模型

PowerNap實施漸進式個人化心率模型機制，在用戶使用一段時間後自動優化睡眠檢測閾值：

1. **數據收集**：
   - 記錄每次確認睡眠時的心率數據
   - 計算用戶實際睡眠心率與靜息心率的比例

2. **模型更新觸發**：
   - 首次使用7天後進行初始分析
   - 之後每14天進行一次模型更新

3. **閾值優化策略**：
   - 基於平均睡眠心率調整閾值比例（漸進式調整）
   - 使用最低心率設定安全限制
   - 根據心率變異性微調最終閾值
   - 每次最多調整2.5個百分點，避免過度調整

### 手動調整閾值

除了基於年齡組的基礎閾值外，系統還會應用使用者在設定中進行的手動調整 (`adjustmentOffset`)。

- **計算:** 最終的心率百分比閾值 = `年齡組基礎百分比 + 手動調整偏移量`。
- **影響:** 
    - 正向偏移 (+%, UI 標示「判定較寬鬆」) 會提高心率門檻值，使 App **更容易**判定入睡。
    - 負向偏移 (-%, UI 標示「判定較嚴格」) 會降低心率門檻值，使 App **更難**判定入睡。
- **應用:** `calculateHeartRateThreshold` 方法會使用這個調整後的百分比來計算最終的心率門檻 (與 RHR 相乘)。

## 睡眠狀態判定

### 狀態定義

PowerNap定義了四種睡眠狀態：

| 狀態 | 描述 | 轉換條件 |
|------|------|----------|
| 清醒 (Awake) | 用戶清醒活動狀態 | 初始狀態 |
| 潛在睡眠 (PotentialSleep) | 可能進入睡眠的過渡狀態 | 同時滿足心率和動作條件 |
| 睡眠中 (Asleep) | 確認用戶已入睡 | 潛在睡眠持續符合年齡組要求時間 |
| 被干擾 (Disturbed) | 睡眠被短暫干擾 | 睡眠中條件不再滿足 |

### 時間門檻參數

| 參數 | 年齡組 | 值（秒） | 說明 |
|------|--------|----------|------|
| sleepConfirmationTimeTeens | 10-17歲 | 120 | 青少年需持續滿足條件的時間（2分鐘） |
| sleepConfirmationTimeAdults | 18-59歲 | 180 | 成人需持續滿足條件的時間（3分鐘） |
| sleepConfirmationTimeSeniors | ≥60歲 | 240 | 老年人需持續滿足條件的時間（4分鐘） |
| motionStillThresholdTime | 所有年齡 | 120 | 需保持靜止的時間（2分鐘） |

### 狀態轉換邏輯

1. **清醒 → 潛在睡眠**：
   - 同時滿足心率條件和動作條件

2. **潛在睡眠 → 睡眠中**：
   - 持續滿足條件達到年齡組對應的確認時間
   - 此時記錄睡眠開始時間，觸發計時器開始倒數

3. **睡眠中 → 被干擾**：
   - 不再同時滿足心率和動作條件

4. **被干擾 → 睡眠中**：
   - 重新滿足條件

5. **被干擾 → 清醒**：
   - 持續不滿足條件超過2分鐘

## 實現注意事項

1. **資源優化**：
   - 動作數據通過窗口處理減少噪音
   - 心率採樣為每15秒一次，平衡準確性和電池消耗

2. **穩健性設計**：
   - 通過多重時間門檻避免誤判
   - 從潛在睡眠到確認睡眠的時間緩衝，降低誤報率

3. **適應性**：
   - 自適應動作閾值，適應不同用戶和環境
   - 個人化心率閾值，考慮年齡和個體差異
   - 運動員特殊模式，處理極低靜息心率的情況

## 診斷與調整

可通過以下信息診斷系統運行狀況：

1. **心率數據**：
   - 靜息心率：`restingHeartRate`
   - 當前心率：`currentHeartRate`
   - 判定閾值：`heartRateThreshold`

2. **動作數據**：
   - 當前動作強度：`currentMotionIntensity`
   - 長窗口平均值：`longWindowAverage`
   - 短窗口平均值：`shortWindowAverage`
   - 動作閾值：`motionThreshold`
   - 靜止時間比例：`stationaryPercentage`

3. **時間統計**：
   - 滿足條件持續時間：`meetingConditionsDuration`
   - 離睡眠確認還需時間：`timeToSleepConfirmation`