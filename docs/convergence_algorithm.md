# PowerNap 自適應調整收斂算法

## 1. 收斂法基本原理

收斂法是一種自適應優化方法，通過逐步減小調整幅度，使系統逐漸接近理想值，並最終穩定在一個最優解。

### 核心理念

- **初期大幅調整**：系統初始階段使用較大調整步長，快速接近目標值
- **中期適度調整**：隨著系統學習增加，逐步減小調整幅度
- **後期微調**：系統趨於穩定後，只進行最小程度的調整或停止調整

### 應用於PowerNap睡眠確認時間

PowerNap應用需要針對不同用戶的生理特性調整睡眠確認時間—連續檢測到睡眠狀態需要的最短時間。該參數決定了系統判定用戶進入睡眠狀態的敏感程度。

## 2. 睡眠確認時間收斂機制

### 當前機制（需改進）

目前系統缺乏真正的收斂機制，存在無限調整的問題：
- 心率波動大時：+30秒
- 心率穩定時：-15秒
- 檢測到假入睡：+45秒
- 檢測到快速入睡：-30秒

### 改進的收斂機制

#### 基於同方向連續調整次數的收斂

- **調整幅度遞減機制**：
  - 第1次同方向調整：±30秒
  - 第2次同方向調整：±15秒
  - 第3次同方向調整：±7秒
  - 第4次同方向調整：±3秒
  - 第5次同方向調整：±1.5秒
  - 第6次同方向調整：±0.7秒
  - 第7次同方向調整：±0.3秒
  - 第8次同方向調整：±0.1秒（最終調整）

- **方向變化處理**：如果調整方向改變，調整幅度重置為±30秒

#### 調整頻率控制

- 首次調整：需經過2次睡眠會話
- 第二次調整：需經過3次睡眠會話
- 第三次及以後調整：需經過4次睡眠會話

#### 停止機制

- 完成同方向第8次調整後停止自動調整
- 用戶提供新的反饋後可重新啟動調整流程

## 3. 使用者反饋機制優化

### 當前問題

- "準確"反饋：固定減少15秒，缺乏收斂
- "不準確"反饋：無法區分"誤報"和"漏報"兩種情況

### 改進建議

#### "準確"反饋收斂

- 使用同樣的同方向調整次數機制：
  - 首次準確反饋：-30秒
  - 第二次準確反饋：-15秒
  - 第三次準確反饋：-7秒
  - 依此類推
  - 第八次後停止調整

#### "不準確"反饋自動識別

系統會根據當前睡眠狀態自動判斷不準確的類型，無需用戶額外指明：

- **誤報自動識別**：當系統處於睡眠狀態(light/deep)但用戶反饋不準確時，自動判定為"判定太快"，增加確認時間
- **漏報自動識別**：當系統處於非睡眠狀態但用戶反饋不準確時，自動判定為"判定太慢"，減少確認時間

兩種情況都應用上述遞減調整機制，確保隨著同方向調整次數增加，調整幅度逐漸減小。

#### 與測試情境的銜接

- **情境2銜接**（用戶入睡，系統未檢測到）：
  - 用戶起床後發現系統仍在監測狀態
  - 按下"不準確"按鈕時，系統自動識別為漏報
  - 應用收斂機制減少確認時間，使系統更易判定為睡眠

- **情境3銜接**（用戶未入睡，系統誤判為睡眠）：
  - 用戶看到睡眠計時器啟動但實際未睡
  - 按下"不準確"按鈕時，系統自動識別為誤報
  - 應用收斂機制增加確認時間，使系統更嚴謹判定睡眠

## 4. 實施計劃

### 第一階段：基礎收斂機制

1. 為睡眠確認時間添加連續同方向調整次數追蹤器
2. 實現基於同方向連續調整次數的遞減調整
3. 添加會話計數器以控制調整頻率

### 第二階段：反饋系統優化

1. 完善自動判斷反饋類型的邏輯
2. 將用戶反饋納入同方向連續調整次數系統
3. 添加調整歷史記錄，便於用戶查看系統學習情況

### 第三階段：長期穩定性優化

1. 實現自動停止調整邏輯
2. 添加手動重置學習過程的選項
3. 為不同使用者場景添加預設配置方案 