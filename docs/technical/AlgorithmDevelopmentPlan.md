# PowerNap 演算法開發計劃（已更新版本）

> **文件定位說明**：本文件專注於 PowerNap 項目的演算法開發計劃和進度追蹤，提供了演算法實現的階段性規劃和技術路線。本文檔偏重於整體演算法架構和開發進度，而非詳細實現。若需了解具體技術實現細節，請參考以下專項文檔：
> - **心率監測與閾值系統**：[HeartRateSystem.md](HeartRateSystem.md)（主要實現文檔）
> - **收斂與睡眠確認系統**：[ConvergenceSystem.md](ConvergenceSystem.md)（專項技術文檔）
> - **睡眠檢測系統**：[SleepDetectionSystem.md](SleepDetectionSystem.md)（系統層文檔）
> - **技術參數表**：[TechnicalParamsTable.md](TechnicalParamsTable.md)（參數定義文檔）
> 
> 若需了解整體專案開發進度，請參考 [DevelopmentOutline.md](DevelopmentOutline.md)。完整的文檔導覽請參考 [TechnicalDocumentationMap.md](TechnicalDocumentationMap.md)。

## 開發階段與技術路線

### 第一階段：基礎設計與準備

1. **共享類型定義**
   - 創建單一的類型定義文件（Models/SharedTypes.swift），包含所有演算法需要的共享枚舉和結構體
   - 定義核心類型：SleepState、AgeGroup、MotionIntensity等
   - 確保正確設置訪問控制級別和Target Membership

2. **服務接口設計**
   - 定義清晰的服務接口（協議）：HeartRateServiceProtocol、MotionServiceProtocol等
   - 分離實現與接口，確保可測試性

### 第二階段：核心服務實現

3. **動作檢測服務 (MotionService)**
   - 實現動作數據收集（使用CoreMotion獲取加速度數據）
   - 設計動作分析演算法（計算動作強度和靜止持續時間）
   - 定義靜止狀態閾值和時間窗口（基於年齡組）
   
   **動作分析窗口實現**：
   - **滑動窗口機制**：
     - 使用SlidingWindow類處理時間序列數據
     - 實現環形緩衝區或雙端隊列存儲時間戳和動作強度
     - 支持多窗口並行分析，同時維護不同時長的窗口
     - 使用增量計算法優化性能
   
   - **百分比閾值判定法**：
     - 依據年齡組配置計算靜止比例要求（青少年80%、成人85%、銀髮族90%）
     - 計算靜止時間佔比 = 靜止樣本數 / 總樣本數
     - 條件滿足邏輯：當靜止佔比 ≥ 要求百分比且持續達到確認時間，判定為靜止狀態
   
   - **自適應閾值系統**：
     - 通過AdaptiveThresholdSystem實現動態閾值調整
     - 收集近期動作數據樣本，計算統計特徵
     - 使用平均值和標準差計算新閾值
     - 應用硬性限制防止極端值
     - 使用指數加權移動平均實現平滑過渡

4. **心率監測服務 (HeartRateService)**
   - 使用HealthKit獲取實時心率數據
   - 計算靜息心率(RHR)基準值
   - 實現基於年齡的心率閾值判定（成人90%、青少年87.5%、老年人93.5%）
   - 開發心率異常檢測和趨勢分析

   **心率分析關鍵實現**：
   - **心率異常追蹤器**：
     - 通過HeartRateAnomalyTracker監測心率異常情況 **（⚠️ 2025-06 起暫停使用）**
     - 計算心率偏離度和異常評分
     - 實現異常心率過濾和基線調整
   
   - **心率閾值優化器**：
     - 通過HeartRateThresholdOptimizer實現閾值自動優化
     - 基於用戶反饋調整閾值，使用不對稱調整策略
     - 實現漸進式小步調整和防止極端值

### 第三階段：整合與協調

5. **睡眠檢測協調器 (SleepDetectionCoordinator)**
   - 整合動作和心率服務的數據
   - 實現睡眠狀態機轉換邏輯（awake -> resting -> lightSleep -> deepSleep）
   - 管理數據流和狀態轉換
   - 實現滑動窗口心率和動作聯合分析
   - 基於年齡組應用不同的檢測參數

6. **睡眠服務整合 (SleepServices)**
   - 管理睡眠監測生命週期和事件處理
   - 協調多個服務的啟動和停止
   - 提供統一的睡眠狀態發布

7. **PowerNap服務實現 (PowerNapServices)**
   - 整合所有核心服務，提供統一接口
   - 實現小睡會話生命週期管理
   - 開發完整的數據記錄系統（四大情境數據記錄）
   - 實現反饋處理和參數優化流程

### 第四階段：測試與優化

8. **數據記錄與分析系統**
   - CSV格式時間序列數據記錄
   - 實現批量寫入優化
   - 開發自動清理過期日誌機制
   - 設計詳細數據分析視圖

9. **參數優化與收斂**
   - 基於實際測試數據調整閾值
   - 實現智能收斂演算法
   - 優化年齡組特定參數

## 實施策略

1. **循序漸進**：先完成一個小組件，確保它正確工作後再進行下一步
2. **頻繁驗證**：每實現一個關鍵功能就進行編譯和測試
3. **分離關注點**：每個服務專注於自己的職責
4. **明確依賴**：清晰表述各組件之間的依賴關係
5. **文檔驅動**：先寫文檔說明，再實現代碼

## 開發進度追蹤

### 第一階段（已完成）
- [x] 共享類型定義文件創建 (Models/SharedTypes.swift)
- [x] 服務接口設計完成（HeartRateServiceProtocol、MotionServiceProtocol等）

### 第二階段（已完成）
- [x] 動作檢測服務完整實現 (Services/MotionService.swift) 
- [x] 滑動窗口機制實現 (Services/SlidingWindow.swift)
- [x] 自適應閾值系統實現 (Services/AdaptiveThresholdSystem.swift)
- [x] 心率監測服務完整實現 (Services/HeartRateService.swift)
- [x] 心率異常追蹤器實現 (Services/HeartRateAnomalyTracker.swift)
- [x] 心率閾值優化器實現 (Services/HeartRateThresholdOptimizer.swift)

### 第三階段（已完成）
- [x] 睡眠檢測協調器完整實現 (SleepDetectionCoordinator.swift)
- [x] 睡眠檢測綜合判定邏輯實現
- [x] 睡眠服務整合 (SleepServices.swift)
- [x] PowerNap核心服務實現 (PowerNapServices.swift)
- [x] 四大情境數據記錄系統實現

### 第四階段（進行中）
- [x] 數據記錄與分析系統實現
- [x] 基本參數優化完成
- [ ] 長期使用數據收集與分析
- [ ] 進階參數自適應優化

## 遇到的問題與解決方案

### 類型引用問題（已解決）
1. **問題描述**：在實現服務時遇到了類型引用問題。無法直接引用SharedTypes.swift中定義的類型，導致編譯錯誤。
2. **採用解決方案**：
   - 確保所有協議和服務實現文件中都正確導入了模組
   - 確保SharedTypes.swift和所有協議文件都添加到了正確的Target Membership
   - 實現更清晰的模組結構，避免循環引用

### 模塊導入問題（已解決）
1. **問題描述**：即使正確設置了Target Membership，在新創建的文件中仍無法正確引用其他文件中定義的類型。

2. **採用解決方案**：
   - 初期：將部分輔助類內聯到各服務實現文件中
   - 改進：創建獨立的服務組件，如SlidingWindow、AdaptiveThresholdSystem等
   - 確保所有文件都在同一個Target中，並使用正確的訪問修飾符

### 背景執行優化問題（已解決）
1. **問題描述**：在背景模式下，數據收集和處理需要優化以減少電池消耗。
2. **採用解決方案**：
   - 實現批量處理和寫入操作
   - 優化數據收集間隔（動態調整採樣頻率）
   - 使用滑動窗口減少計算頻率
   - 嚴格控制日誌記錄頻率

### 數據記錄系統優化（已實現）
1. **問題描述**：需要優化數據記錄系統，支持四大情境數據（真陽性、假陰性、假陽性、真陰性）。
2. **採用解決方案**：
   - 重新設計數據記錄觸發機制
   - 在任何監測結束時都記錄完整的分析數據
   - 實現基於情境的數據分類和標記
   - 優化存儲策略，控制日誌大小

## 演算法特性與優化

### 心率閾值收斂演算法
- **不對稱調整策略**：
  - 誤報（假陽性）和漏報（假陰性）採用不同權重
  - 漏報調整（提高敏感度）使用更小步長
  - 誤報調整（降低敏感度）使用更大步長
- **漸進式小步調整**：
  - 初始調整步長較大（±2.5%）
  - 隨著穩定性提高，步長逐漸減小
  - 最小步長限制為±0.5%
- **防止極端值**：
  - 設置硬性上下限（70%-98%）
  - 連續多次相同方向調整後進行限速
  - 檢測並阻止頻繁反復調整

### 睡眠檢測狀態機演算法
- **四階段轉換邏輯**：
  - awake -> resting -> lightSleep -> deepSleep
  - 每階段有明確的進入和退出條件
  - 狀態持續時間要求（防止短暫滿足條件導致頻繁狀態切換）
- **延遲確認機制**：
  - 進入下一階段需要持續滿足條件
  - 退出當前階段需要明確不滿足條件
  - 臨界狀態處理邏輯（防止抖動）
- **年齡特定參數**：
  - 青少年：心率閾值87.5%，確認時間2分鐘
  - 成人：心率閾值90%，確認時間3分鐘
  - 銀髮族：心率閾值93.5%，確認時間4分鐘

## 未來演算法優化方向

### 短期優化計劃
1. **碎片化睡眠模式支持**：
   - 改進狀態機以更好識別短暫睡眠
   - 優化微覺醒檢測
   - 允許更靈活的狀態轉換

2. **個人化敏感度調整**：
   - 開發用戶界面允許自定義敏感度
   - 實現更細粒度的閾值調整
   - 支持多配置文件切換

### 中長期演算法研究方向
1. **機器學習增強**：
   - 收集更多用戶數據建立個人化模型
   - 研究應用簡單的機器學習模型
   - 探索設備上輕量級推理可行性

2. **多設備數據融合**：
   - 研究同時整合多個傳感器數據
   - 開發更穩健的數據融合算法
   - 探索多模態數據分析可能性 