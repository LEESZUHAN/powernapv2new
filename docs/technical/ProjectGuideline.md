# PowerNap: Apple Watch 短暫小睡偵測與喚醒應用

> **文件定位說明**：本文件是 PowerNap 專案的概述性指導文件，提供整體架構和核心功能的簡明介紹，適合新開發者入門或審查人員快速瀏覽。本文僅包含高層次功能描述和設計理念，不涉及詳細實現細節。
> 
> **相關文件索引**：
> - **技術文檔導覽**：請參考 [TechnicalDocumentationMap.md](TechnicalDocumentationMap.md)
> - **開發進度與階段規劃**：請參考 [DevelopmentOutline.md](DevelopmentOutline.md)
> - **演算法開發計劃**：請參考 [AlgorithmDevelopmentPlan.md](AlgorithmDevelopmentPlan.md)
> - **睡眠檢測系統**：請參考 [SleepDetectionSystem.md](SleepDetectionSystem.md)
> - **心率監測與閾值系統**：請參考 [HeartRateSystem.md](HeartRateSystem.md)
> - **收斂與睡眠確認系統**：請參考 [ConvergenceSystem.md](ConvergenceSystem.md)
> - **技術參數表**：請參考 [TechnicalParamsTable.md](TechnicalParamsTable.md)
> 
> 深入了解各模組的具體實現請參考相應的專項文件。

## 專案概述與目標

PowerNap 是一款專為 Apple Watch 設計的應用程式，旨在協助使用者進行高效的短暫小睡（Power Nap）。應用的核心功能是偵測使用者何時進入睡眠狀態，並在使用者預設的時間長度後將其喚醒，以獲取最佳的休息效果而不干擾夜間睡眠規律。

**核心功能流程**：
1. 用戶使用時間選擇器自由選擇 Power Nap 時長（1-30 分鐘範圍內）
2. 開始監測使用者生理數據
3. 當偵測到使用者已入睡，開始倒數計時
4. 倒數結束時發出通知/鬧鐘喚醒使用者

## 技術實現

### 入睡偵測演算法

我們採用綜合性方法偵測使用者是否已入睡，結合以下數據源：

**1. 心率監測**：
- 當使用者進入睡眠狀態，心率通常會下降至低於靜息心率的特定百分比
- 我們將使用 HealthKit 存取心率數據和靜息心率(RHR)數據
- 根據用戶年齡採用不同閾值標準：
  - 10–17 歲（青少年）：心率低於 RHR 的 87.5%，且維持 ≥ 2 分鐘
  - 18–59 歲（成人）：心率低於 RHR 的 90%，且維持 ≥ 3 分鐘
  - ≥ 60 歲（銀髮族）：心率低於 RHR 的 93.5%，需延長觀察窗至 ≥ 4 分鐘
- 特殊情況處理：針對高訓練運動員（RHR 極低，40 bpm 以下），透過 HeartRateAnomalyTracker 和心率閾值自動優化機制處理異常情況 **（註：HRAT 自 2025-06 起已暫時停用）**
- 詳細技術實現請參考 HeartRateThresholdGuideline.md（主要技術文件）、HeartRateAlgorithmGuideline.md（補充文件）和 convergence_algorithm.md（收斂算法）

**2. 活動偵測**：
- 使用 Core Motion 框架監測使用者運動狀態
- 設定時間窗口（如 5 分鐘）計算活動量 Motion_level
- 使用滑動窗口分析靜止比例，根據年齡組設定不同靜止比例閾值（青少年80%、成人75%、銀髮族70%）
- 可利用 CMMotionManager 或 CMMotionActivityManager 等 API

**3. 個人化心率模型與自適應閾值系統**：
- 收集用戶睡眠心率數據，進行個人化閾值優化
- 綜合分析平均睡眠心率（30%權重）與最低心率（70%權重）進行閾值計算
- 採用收斂機制自動優化閾值，進行漸進式調整：
  - 初始優化：累積至少5次睡眠記錄且自首次使用起至少7天後
  - 定期優化：距上次更新超過14天或有新的用戶反饋時
  - 每次調整幅度隨同方向連續調整次數逐步減小（收斂機制）
- 支持用戶手動調整閾值（±5%範圍內）

**4. 綜合判定公式**：
```
Detect Sleep if: (Heart_Rate ≤ RHR × age_threshold) AND (Motion_level ≤ Mthreshold) for duration_threshold
```

當上述條件同時滿足持續一段時間（根據年齡組不同為2-4分鐘），應用將判定使用者已進入睡眠狀態。

### 入睡後倒數計時

與市面上其他應用不同，PowerNap 不是在設定時間後直接喚醒，而是在**確認使用者已入睡後**才開始計時：

1. 使用者使用滾輪選擇器選擇預定的小睡時長（1-30 分鐘範圍內任意時間）
2. 當偵測到入睡，記錄入睡時間戳並開始倒數
3. 倒數時間 = 使用者選擇的小睡時長
4. 倒數結束時觸發喚醒通知

### 背景執行與電池優化

為確保應用可靠運行，我們將：

- 使用 WKExtendedRuntimeSession 使應用在螢幕關閉後繼續運行
- 謹慎管理感測器採樣頻率，平衡準確性與電池消耗
- 在使用者開始 Power Nap 時啟動監測，避免連續背景監控
- 優化演算法計算效率，減少資源消耗
- 使用批量處理和寫入操作，減少磁盤訪問
- 優化數據收集間隔（每15-30秒評估一次睡眠狀態）

### 通知與喚醒機制

使用 UNUserNotificationCenter 實現喚醒功能：

- 在倒數結束時觸發本地通知
- 附帶聲音與震動以有效喚醒使用者
- 設置為 Time Sensitive 通知，確保即使在專注模式下也能提醒
- 可能提供喚醒後的數據摘要（如實際睡眠時間）

## 使用者體驗與設計原則

### 應用流程

1. **設置階段**：
   - 使用滾輪選擇器直觀選擇 1-30 分鐘範圍內的任意時間
   - 年齡組選擇設定（影響心率判定標準）(初次使用app時，若可以從系統得到使用者年齡，直接採用。若否，請使用者選擇年齡區間)
   - 可選的設置（如喚醒鈴聲選擇、心率閾值手動微調）

2. **監測階段**：
   - 顯示簡潔的等待入睡狀態介面
   - 一旦偵測到入睡，切換至倒數計時顯示（可選，視電源影響）

3. **喚醒階段**：
   - 發出清晰的喚醒通知
   - 提供簡短的小睡成效回饋（如「成功小睡 15 分鐘」）
   - 收集用戶反饋用於優化閾值系統

### 設計重點

- 遵循 Apple Watch Human Interface Guidelines
- 極簡的介面設計，減少操作步驟
- 清晰的視覺反饋，即使在光線不佳環境下也易讀
- 支援錶盤複雜功能（Complication），提供快速啟動方式

## 開發考量與挑戰

1. **技術挑戰**：
   - 準確獲取靜息心率數據
   - 根據用戶年齡實現差異化判定標準
   - 在有限硬體資源下長時間穩定運行
   - 確保通知可靠喚醒使用者

2. **效能優化**：
   - 平衡感測器頻率與電池消耗
   - 最佳化演算法計算頻率
   - 避免過度喚醒 CPU 和過熱

3. **驗證方法**：
   - 與實際入睡/醒來時間對比測試準確率
   - 測試不同年齡組的心率閾值判定準確性
   - 電池消耗測試（確保單次小睡耗電可接受）
   - 收斂算法效能測試（檢驗閾值優化是否穩定可靠）

## 開發路線

1. **最小可行產品（MVP）**：
   - 實現基本入睡偵測（結合心率 + 活動監測）
   - 倒數計時與喚醒功能
   - 簡單的使用者介面

2. **增強功能（後續迭代）**：
   - 個人化心率模型（根據用戶數據優化閾值）
   - 收斂機制增強（漸進式小步調整、不對稱調整策略）
   - 睡眠質量評估（入睡速度等指標）
   - 統計與趨勢分析
   - 多種喚醒方式選擇
   - 運動員特殊模式與碎片化睡眠模式

## 開發環境與技術要求

- 開發語言：Swift
- 框架：SwiftUI（介面）、HealthKit（健康數據）、CoreMotion（動作感測）
- 目標 OS：watchOS 10.0+
- 開發工具：最新版 Xcode

## 參考數據

- 理想短暫小睡時長：10-20 分鐘（避免進入深睡眠階段）
- 睡眠對心率的影響：短暫小睡時心率通常下降5-10%（相較於靜息心率）
- 典型入睡判定時間窗口：根據年齡組不同為2-4分鐘的持續條件滿足
- 靜止比例閾值：青少年80%、成人75%、銀髮族70%（基於實際代碼實現）

---
注意：本指南將根據開發進度與測試結果持續更新。核心理念變更會在本文件中體現。詳細技術實現請參考相關專項文件。 