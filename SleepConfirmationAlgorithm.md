# 睡眠確認時間收斂算法

## 概述

睡眠確認時間收斂算法是PowerNap應用中自動優化睡眠檢測參數的關鍵機制。該算法通過用戶反饋逐步調整系統判定為睡眠需要的持續時間，使系統能夠適應不同用戶的睡眠特徵。

## 算法設計原則

1. **漸進式調整**：調整幅度隨著同方向連續調整次數逐漸減少
2. **方向敏感**：根據反饋類型自動判斷調整方向
3. **頻率控制**：隨著調整次數增加，要求更多會話間隔
4. **自動停止**：達到一定調整次數後自動停止，避免過度調整

## 核心機制

### 用戶反饋類型

系統根據用戶反饋和當前睡眠狀態，自動判斷適當的調整方向：

- **誤報（False Positive）**：系統誤判為睡眠，但用戶實際未入睡
  - 表示系統過於寬鬆，需要增加確認時間
  - 調整方向：+1（增加確認時間）

- **漏報（False Negative）**：系統未檢測到睡眠，但用戶實際已入睡
  - 表示系統過於嚴謹，需要減少確認時間
  - 調整方向：-1（減少確認時間）

- **準確（Accurate）**：系統正確判斷了用戶的睡眠狀態
  - 表示當前參數工作良好，不需要調整
  - 調整方向：0（不調整）

### 調整幅度控制

根據連續同方向調整次數決定調整幅度：

| 連續調整次數 | 調整幅度(秒) |
|------------|------------|
| 0          | 30.0       |
| 1          | 15.0       |
| 2          | 7.0        |
| 3          | 3.0        |
| 4          | 1.5        |
| 5          | 0.7        |
| 6          | 0.3        |
| 7          | 0.1        |
| 8+         | 0.0 (停止) |

### 調整頻率控制

隨著調整次數增加，進行下一次調整所需的會話數量增加：

| 調整次數 | 所需會話數 |
|---------|-----------|
| 0 (首次) | 2         |
| 1       | 3         |
| 2+      | 4         |

### 限制條件

- 確認時間範圍限制：60-360秒（1-6分鐘）
- 連續8次同方向調整後自動停止調整
- 方向改變時重置連續計數

## 實現細節

### 調整觸發條件

1. **實際睡眠後的用戶反饋**：
   - 當用戶完成實際睡眠會話並提供反饋時，系統根據反饋類型調整參數
   - 準確反饋不會觸發調整，因為系統已達到理想效果

2. **測試按鈕模擬**：
   - 通過測試按鈕模擬的反饋不會真實調整系統參數
   - 系統通過`isSimulatingFeedback()`方法識別測試情境

### 關鍵代碼

```swift
// 計算基於連續調整次數的調整幅度(秒)
private func calculateAdjustmentAmount(for consecutiveCount: Int) -> TimeInterval {
    switch consecutiveCount {
    case 0: return 30.0
    case 1: return 15.0
    case 2: return 7.0
    case 3: return 3.0
    case 4: return 1.5
    case 5: return 0.7
    case 6: return 0.3
    case 7: return 0.1
    default: return 0.0  // 第8次以後停止調整
    }
}

// 獲取進行下一次調整所需的會話數
private func getRequiredSessionsCount(forAdjustment adjustmentCount: Int) -> Int {
    switch adjustmentCount {
    case 0: return 2  // 首次調整需要2次會話
    case 1: return 3  // 第二次調整需要3次會話
    default: return 4 // 第三次及以後需要4次會話
    }
}
```

## 最近更新（2024-05-15）

1. **準確反饋不再調整參數**：
   - 當用戶反饋系統判斷準確時，不再觸發確認時間調整
   - 理由：系統表現良好時不需要調整參數

2. **明確區分測試情境**：
   - 通過`isSimulatingFeedback()`方法確保測試按鈕不會影響實際數據
   - 僅實際睡眠後的反饋才會觸發真實調整

## 未來改進方向

1. **個人化初始值**：根據用戶年齡、活動水平等因素設定更合適的初始確認時間
2. **季節性調整**：考慮季節、日光時間等因素對睡眠模式的影響
3. **學習率優化**：根據用戶使用頻率動態調整學習率
4. **多參數協同優化**：將確認時間調整與心率閾值、靜止比例等參數協同優化 